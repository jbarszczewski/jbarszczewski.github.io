<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Rust + Actix + CosmosDB (MongoDB) Web API tutorial |</title><meta name=Description content><meta property="og:title" content="Rust + Actix + CosmosDB (MongoDB) Web API tutorial"><meta property="og:description" content="Intro When working on one of my projects I decided to create simple logging API and Rust seemed like a perfect choice to learn some new tech. Same goes for going with Azure CosmosDB which now offer free tier that is perfect for learning and small personal projects.
I consider this tutorial to be a good starting point for beginner rustaceans (I&rsquo;m one of those) but I assume that you know the basics."><meta property="og:type" content="article"><meta property="og:url" content="https://jbarszczewski.com/posts/rust-actix-webapi/"><meta property="article:published_time" content="2020-06-27T21:39:52+00:00"><meta property="article:modified_time" content="2020-06-27T21:39:52+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust + Actix + CosmosDB (MongoDB) Web API tutorial"><meta name=twitter:description content="Intro When working on one of my projects I decided to create simple logging API and Rust seemed like a perfect choice to learn some new tech. Same goes for going with Azure CosmosDB which now offer free tier that is perfect for learning and small personal projects.
I consider this tutorial to be a good starting point for beginner rustaceans (I&rsquo;m one of those) but I assume that you know the basics."><meta name=application-name content="jbarszczewski"><meta name=apple-mobile-web-app-title content="jbarszczewski"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jbarszczewski.com/posts/rust-actix-webapi/><link rel=next href=https://jbarszczewski.com/posts/rust-cli-game-part1/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Rust + Actix + CosmosDB (MongoDB) Web API tutorial","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jbarszczewski.com\/posts\/rust-actix-webapi\/"},"genre":"posts","wordCount":1235,"url":"https:\/\/jbarszczewski.com\/posts\/rust-actix-webapi\/","datePublished":"2020-06-27T21:39:52+00:00","dateModified":"2020-06-27T21:39:52+00:00","publisher":{"@type":"Organization","name":"Author"},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':(''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=jbarszczewski class=header-logo>jbarszczewski</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=jbarszczewski class=header-logo>jbarszczewski</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><div class=breadcrumbs><a href=/>Home </a>/ <a href=/>Rust + Actix + CosmosDB (MongoDB) Web API tutorial</a></div><h1 class="single-title animated flipInX">Rust + Actix + CosmosDB (MongoDB) Web API tutorial</h1><div class=post-meta><div class=post-meta-line>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class=timeago datetime=2020-06-27>2020-06-27</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1235 words
&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes</div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><h1 id=intro>Intro</h1><p>When working on one of my projects I decided to create simple logging API and Rust seemed like a perfect choice to learn some new tech. Same goes for going with Azure CosmosDB which now offer free tier that is perfect for learning and small personal projects.</p><p>I consider this tutorial to be a good starting point for beginner rustaceans (I&rsquo;m one of those) but I assume that you know the basics. I highly recommend going through official <a href=https://github.com/rust-lang/rustlings target=_blank rel="noopener noreffer">rustlings tutorial</a>.</p><p>&ldquo;Final&rdquo; code can be found on my <a href=https://github.com/jbarszczewski/plant-server target=_blank rel="noopener noreffer">github repo</a></p><h1 id=setting-up-hello-fellow-rustacean>Setting up &ldquo;Hello fellow Rustacean!&rdquo;</h1><p>First let&rsquo;s create a new project by either creating new project directory and running <code>cargo init</code> from it or using <code>cargo new {project-name}</code> that also create directory for you. Once you&rsquo;re ready open your editor of choice (VS Code here with official &lsquo;Rust&rsquo; extensions and &lsquo;cargo&rsquo; that helps with staying up do date with dependencies) and let&rsquo;s start!</p><p>We will begin by creating simple http server that return us classic greatings. Open <code>Cargo.toml</code> and add two new dependencies:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=p>[</span><span class=l>dependencies]</span><span class=w>
</span><span class=w></span><span class=l>actix-rt = &#34;1.1.1&#34;</span><span class=w>
</span><span class=w></span><span class=l>actix-web = &#34;2.0&#34;</span><span class=w>
</span></code></pre></div><p><strong>Note:</strong> First stick with versions I used for this tutorial and then update. I found that already few crates had some breaking changes so it&rsquo;s safer to application working first.</p><p>Then replace code in main.rs with the one below:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>web</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>env</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[actix_rt::main]</span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>env</span>::<span class=n>set_var</span><span class=p>(</span><span class=s>&#34;RUST_LOG&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;actix_web=debug&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=n>App</span>::<span class=n>new</span><span class=p>().</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>hello</span><span class=p>)))</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span><span class=o>?</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>hello</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Responder</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;Hello fellow Rustacean!&#34;</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span></code></pre></div><p>That&rsquo;s it! now just <code>cargo run</code> and go to <code>127.0.0.1:8000</code> in your browser.</p><p>Let&rsquo;s quickly see what we did here:</p><ol><li><code>#[actix_rt::main]</code> marked our main async function as to be executed in actix runtime.</li><li><code>"RUST_LOG"</code>sets logger used by actix to output errors.</li><li>New <code>App</code> with registered request handler is passed to <code>HttpServer</code> to listen for incoming connections.</li></ol><h1 id=creating-service-configuration>Creating service configuration</h1><p>As you can see, right now we&rsquo;ve registered our routes in main function. In this tutorial we won&rsquo;t have many resources but it&rsquo;s good practice to have cleaner structure. Create new file: <code>src\logs_handlers\mod.rs</code> and add code below:</p><pre><code>use actix_web::{web, Responder};

pub fn scoped_config(cfg: &amp;mut web::ServiceConfig) {
	cfg.service(
		web::resource(&quot;/logs&quot;)
			.route(web::get().to(get_logs))
			.route(web::post().to(add_log)),
	);
}

async fn get_logs() -&gt; impl Responder {
	format!(&quot;Not yet implemented!&quot;)
}

async fn add_log() -&gt; impl Responder {
	format!(&quot;Not yet implemented!&quot;)
}

</code></pre><p>The <code>scoped_config()</code> function is responsible for registering logs resource configuration in our service. That means we can create multiple modules for each resource and then just call this configurator function for each of them from our <code>main</code> function. So, let&rsquo;s do that by modifying <code>App</code> builder code:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=n>App</span>::<span class=n>new</span><span class=p>().</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/api&#34;</span><span class=p>).</span><span class=n>configure</span><span class=p>(</span><span class=n>logs_handlers</span>::<span class=n>scoped_config</span><span class=p>))</span><span class=w>
</span></code></pre></div><p>Don&rsquo;t forget to import newly created module as well and add</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>mod</span> <span class=nn>logs_handlers</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>below the <code>use</code> block.</p><p>Now we&rsquo;ve set up our api to handle GET and POST methods on route <code>api/logs</code>. Try it!</p><h1 id=connecting-to-cosmosdbmongodb>Connecting to CosmosDB/MongoDB</h1><p>In this tutorial I use free tier Azure CosmosDB database with MongoDB API, but of course the choice is yours. Let&rsquo;s create db client and return some data. When I was prototyping my API, I was creating client in the handler manually. That is really inefficient way, instead we can utilize client pooling build in MongoDB client crate and setup it on app startup. Add MongoDB dependency to <code>Cargo.toml</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=l>bson = &#34;1.0.0&#34;</span><span class=w>
</span><span class=w></span><span class=l>futures = &#34;0.3.5&#34;</span><span class=w>
</span><span class=w></span><span class=l>mongodb = &#34;1.0.0&#34;</span><span class=w>
</span></code></pre></div><p>Open <code>main.rs</code> and add import module:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>mongodb</span>::<span class=p>{</span><span class=n>options</span>::<span class=n>ClientOptions</span><span class=p>,</span><span class=w> </span><span class=n>Client</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>And then modify your main function to look like this:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=cp>#[actix_rt::main]</span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>env</span>::<span class=n>set_var</span><span class=p>(</span><span class=s>&#34;RUST_LOG&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;actix_web=debug&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>client_options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientOptions</span>::<span class=n>parse</span><span class=p>(</span><span class=s>&#34;mongodb://free-tier-db:yfQtNbXyW2h9HUOOplCeHgjzzbJMnfMQn2BZuzAkw5gv0uBkqbdbQPdnQ98e6UtS5Z3p1ZrG4rgkmEKBURNgwg==@free-tier-db.mongo.cosmos.azure.com:10255/?ssl=true&amp;replicaSet=globaldb&amp;retrywrites=false&amp;maxIdleTimeMS=120000&amp;appName=@free-tier-db@&#34;</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=n>client_options</span><span class=p>.</span><span class=n>app_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=s>&#34;PlantApi&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>web</span>::<span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=n>Client</span>::<span class=n>with_options</span><span class=p>(</span><span class=n>client_options</span><span class=p>).</span><span class=n>unwrap</span><span class=p>()));</span><span class=w>
</span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/api&#34;</span><span class=p>).</span><span class=n>configure</span><span class=p>(</span><span class=n>logs_handlers</span>::<span class=n>scoped_config</span><span class=p>))</span><span class=w>
</span><span class=w>    </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span><span class=o>?</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p><strong>Note:</strong> Replace connection string with yours. Don&rsquo;t worry we will not leave connection string in the code in the final version.</p><p>Our new code creates a MongoDB client that is wrapped in mutex object for thread safety and which in turn is passed to application data object that is responsible for making it available in handlers.</p><h1 id=fetching-logs>Fetching logs</h1><p>Now we are ready to connect to our DB and make use of it. Go to <code>logs_handlers/mod.rs</code> and import few more modules:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>web</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>bson</span>::<span class=p>{</span><span class=n>doc</span><span class=p>,</span><span class=w> </span><span class=n>Bson</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>futures</span>::<span class=n>stream</span>::<span class=n>StreamExt</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>mongodb</span>::<span class=p>{</span><span class=n>options</span>::<span class=n>FindOptions</span><span class=p>,</span><span class=w> </span><span class=n>Client</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Mutex</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>MONGO_DB</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span><span class=w> </span><span class=kt>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;iotPlantDB&#34;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>MONGO_COLL_LOGS</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span><span class=w> </span><span class=kt>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;logs&#34;</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>...</span><span class=c1>// no changes in  scoped_config
</span><span class=c1></span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_logs</span><span class=p>(</span><span class=n>data</span>: <span class=nc>web</span>::<span class=n>Data</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Client</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Responder</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>logs_collection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>lock</span><span class=p>()</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>database</span><span class=p>(</span><span class=n>MONGO_DB</span><span class=p>)</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>collection</span><span class=p>(</span><span class=n>MONGO_COLL_LOGS</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>doc</span><span class=o>!</span><span class=w> </span><span class=p>{};</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>find_options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FindOptions</span>::<span class=n>builder</span><span class=p>().</span><span class=n>sort</span><span class=p>(</span><span class=n>doc</span><span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&#34;_id&#34;</span>: <span class=o>-</span><span class=mi>1</span><span class=p>}).</span><span class=n>build</span><span class=p>();</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>cursor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logs_collection</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>filter</span><span class=p>,</span><span class=w> </span><span class=n>find_options</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span><span class=w>	</span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cursor</span><span class=p>.</span><span class=n>next</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>		</span><span class=k>match</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>			</span><span class=nb>Ok</span><span class=p>(</span><span class=n>document</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>				</span><span class=n>results</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>document</span><span class=p>);</span><span class=w>
</span><span class=w>			</span><span class=p>}</span><span class=w>
</span><span class=w>			</span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=n>InternalServerError</span><span class=p>().</span><span class=n>finish</span><span class=p>();</span><span class=w>
</span><span class=w>			</span><span class=p>}</span><span class=w>
</span><span class=w>		</span><span class=p>}</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w>	</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>json</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>...</span><span class=w> </span><span class=c1>// no changes in add_log
</span></code></pre></div><p>Ok, let&rsquo;s see what we did here.</p><ol><li>We created two constants to hold our DB and collection names.</li><li>Our <code>get_logs</code> function accept application data (our MongoDB client that we&rsquo;ve set up in <code>main</code> function).</li><li>We use client to give us handle to the logs collection.</li><li><code>find</code> function is used with no filter (returns everything) and simple sort by _id</li><li>We iterate results using <code>cursor</code> returned by <code>find </code>and populate result vector with incoming documents which then is returned in json format.</li></ol><p>Now make sure you have some data in your DB and you&rsquo;re ready to test first call. My test data, and the one I will be using in <code>add_log</code> handler looks like this:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
	<span class=nt>&#34;_id&#34;</span><span class=p>:</span> <span class=p>{</span>
		<span class=nt>&#34;$oid&#34;</span><span class=p>:</span> <span class=s2>&#34;5ee3bb1f00bc6d3b007b79ca&#34;</span>
	<span class=p>},</span>
	<span class=nt>&#34;deviceId&#34;</span><span class=p>:</span> <span class=s2>&#34;mock_device-01&#34;</span><span class=p>,</span>
	<span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;test message&#34;</span><span class=p>,</span>
	<span class=nt>&#34;createdOn&#34;</span><span class=p>:</span> <span class=p>{</span>
		<span class=nt>&#34;$date&#34;</span><span class=p>:</span> <span class=s2>&#34;2020-06-12T17:27:59.404Z&#34;</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Before we move to implementing POST handler let&rsquo;s do one more change. We should move the connection string out from the code. Let&rsquo;s save it as environmental variable named <code>CONNECTION_STRING_LOGS</code> and then we can replace line responsible for creating client options in <code>main.rs</code> with this:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>mongo_url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;CONNECTION_STRING_LOGS&#34;</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>client_options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientOptions</span>::<span class=n>parse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mongo_url</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></code></pre></div><p>Much nicer solution!</p><h1 id=adding-logs>Adding logs</h1><p>It&rsquo;s time to finish our api with the <code>add_log</code> handler. Add two more dependecies, <code>chrono</code> and <code>serde</code>, first will help us with DateTime and latter is the most popular serialize/deserialize crate. Your final dependency list should look like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=p>[</span><span class=l>dependencies]</span><span class=w>
</span><span class=w></span><span class=l>actix-rt = &#34;1.1.1&#34;</span><span class=w>
</span><span class=w></span><span class=l>actix-web = &#34;2.0&#34;</span><span class=w>
</span><span class=w></span><span class=l>bson = &#34;1.0.0&#34;</span><span class=w>
</span><span class=w></span><span class=l>chrono = &#34;0.4.11&#34;</span><span class=w>
</span><span class=w></span><span class=l>futures = &#34;0.3.5&#34;</span><span class=w>
</span><span class=w></span><span class=l>mongodb = &#34;1.0.0&#34;</span><span class=w>
</span><span class=w></span><span class=l>serde = { version = &#34;1.0&#34;, features = [&#34;derive&#34;] }</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s go back to <code>logs_handlers/mod.rs</code>, import newly added modules and add struct for new logs:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>chrono</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>serde</span>::<span class=n>Deserialize</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[derive(Deserialize)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>NewLog</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>message</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p><code>NewLog</code> has <code>derive(Deserialize)</code> trait as this will be used to deserialize incoming POST body. We only need device/source id and a message to log, timestamp will be created in the handler function and MongoDB object id by the database.
Replace <code>add_log</code> function with:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>add_log</span><span class=p>(</span><span class=n>data</span>: <span class=nc>web</span>::<span class=n>Data</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Client</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w> </span><span class=n>new_log</span>: <span class=nc>web</span>::<span class=n>Json</span><span class=o>&lt;</span><span class=n>NewLog</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Responder</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>logs_collection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>lock</span><span class=p>()</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>database</span><span class=p>(</span><span class=n>MONGO_DB</span><span class=p>)</span><span class=w>
</span><span class=w>		</span><span class=p>.</span><span class=n>collection</span><span class=p>(</span><span class=n>MONGO_COLL_LOGS</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>	</span><span class=k>match</span><span class=w> </span><span class=n>logs_collection</span><span class=p>.</span><span class=n>insert_one</span><span class=p>(</span><span class=n>doc</span><span class=o>!</span><span class=w> </span><span class=p>{</span><span class=s>&#34;deviceId&#34;</span>: <span class=kp>&amp;</span><span class=nc>new_log</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=s>&#34;message&#34;</span>: <span class=kp>&amp;</span><span class=nc>new_log</span><span class=p>.</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=s>&#34;createdOn&#34;</span>: <span class=nc>Bson</span>::<span class=n>DateTime</span><span class=p>(</span><span class=n>Utc</span>::<span class=n>now</span><span class=p>())},</span><span class=w> </span><span class=nb>None</span><span class=p>).</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>db_result</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>new_id</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db_result</span><span class=p>.</span><span class=n>inserted_id</span><span class=p>.</span><span class=n>as_object_id</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;New document inserted with id {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>new_id</span><span class=p>);</span><span class=w>   
</span><span class=w>            </span><span class=p>}</span><span class=w>
</span><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=n>Created</span><span class=p>().</span><span class=n>json</span><span class=p>(</span><span class=n>db_result</span><span class=p>.</span><span class=n>inserted_id</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>err</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w>
</span><span class=w>        </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;Failed! {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=n>InternalServerError</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>As with <code>get_logs</code> this function makes use of mongo client stored in application data to get handle to the logs collection. Notice additional parameter <code>new_log</code> of type <code>NewLog</code> that we&rsquo;ve created before. If your body match the struct (names and value types) it will be properly deserialized and ready to use. What this function does is:</p><ol><li>Dynamically creates document using <code>new_log</code> data and fill <code>createdOn</code> with current UTC date and time.</li><li>Check the results and returns new document id if success.</li></ol><p>And we&rsquo;re done! Two simple functions that can handle incoming GET and POST requests. Run the application and test it by adding new logs:</p><pre><code class=language-curl data-lang=curl>curl --location --request POST 'localhost:8000/api/logs' \
--header 'Content-Type: application/json' \
--data-raw '{
    &quot;id&quot;:&quot;tutorial-client&quot;,
    &quot;message&quot;:&quot;I'\''m a Rustacean!&quot;
}'
</code></pre><h1 id=optional-get_logs-code>Optional <code>get_logs</code> code</h1><p>This is a simple example so our <code>get_logs</code> function returns documents in the format it receives them. But what if we want to perform some operations on the results before we return them? We can easily deserialize document (and check if it matches our model) by modifying code slightly:
We add few more imports:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>bson</span>::<span class=p>{</span><span class=n>doc</span><span class=p>,</span><span class=w> </span><span class=n>oid</span>::<span class=n>ObjectId</span><span class=p>,</span><span class=w> </span><span class=n>Bson</span><span class=p>,</span><span class=w> </span><span class=n>UtcDateTime</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>serde</span>::<span class=p>{</span><span class=n>Deserialize</span><span class=p>,</span><span class=w> </span><span class=n>Serialize</span><span class=p>};</span><span class=w>
</span></code></pre></div><p>Specify <code>Log</code> structure as it wil be different than <code>NewLog</code></p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Deserialize, Debug)]</span><span class=w>
</span><span class=w></span><span class=cp>#[serde(rename_all = </span><span class=s>&#34;camelCase&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Log</span><span class=w> </span><span class=p>{</span><span class=w>    
</span><span class=w>    </span><span class=cp>#[serde(rename = </span><span class=s>&#34;_id&#34;</span><span class=cp>)]</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>id</span>: <span class=nc>ObjectId</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=cp>#[serde(rename = </span><span class=s>&#34;deviceId&#34;</span><span class=cp>)]</span><span class=w>	
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>device_id</span>: <span class=nb>String</span><span class=p>,</span><span class=w>	
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>message</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>timestamp</span>: <span class=nc>UtcDateTime</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>And just above the line where we push received document into the results vector, deserialize it using model above:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=kd>let</span><span class=w> </span><span class=n>log</span>: <span class=nc>Log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bson</span>::<span class=n>from_bson</span><span class=p>(</span><span class=n>Bson</span>::<span class=n>Document</span><span class=p>(</span><span class=n>document</span><span class=p>)).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>We arrived at the end of this tutorial. As you can see it&rsquo;s not that complicated to create APIs in Rust. Of course, the example above is quite simple, but I think it&rsquo;s a good starting point even if you&rsquo;re not that familiar with Rust.
Please leave a comment if you liked (or not) this article or if something doesn&rsquo;t seem right etc.</p><p>Thanks for reading and till the next time!</p></div><div class=post><div class=post-info-share><span></span></div><div class=post-footer id=post-footer><div class=post-navigation><div class="post-nav-box nav-box-next"><a class=nav-box href=/posts/rust-cli-game-part1/><div style=padding-right:10px><div class=nav-text-h>Next article</div><span class=nav-text>Rust CLI Game of Life tutorial - PART 1</span></div><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8c137 0 248 111 248 248S393 504 256 504 8 393 8 256 119 8 256 8zm113.9 231L234.4 103.5c-9.4-9.4-24.6-9.4-33.9.0l-17 17c-9.4 9.4-9.4 24.6.0 33.9L285.1 256 183.5 357.6c-9.4 9.4-9.4 24.6.0 33.9l17 17c9.4 9.4 24.6 9.4 33.9.0L369.9 273c9.4-9.4 9.4-24.6.0-34z"/></svg></span></a></div></div></div></div></div><div id=toc-final></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://jbarszczewski.com/&utm_medium=footer&utm_campaign=config&utm_term=1.2.0" target=_blank title="uBlogger 1.2.0"><i class="fas fa-pencil-alt fa-fw"></i>uBlogger</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span>2021</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10}};</script><script src=/js/theme.min.js></script><script src=/js/jquery-3.5.1.min.js></script></body></html>